<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color);
        }
        
        .subtitle {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color);
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #0088cc);
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .input-hint {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
            margin-top: 4px;
        }
        
        .summary {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
        }
        
        .summary-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--tg-theme-text-color);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .summary-item.total {
            border-top: 2px solid var(--tg-theme-hint-color, #ddd);
            margin-top: 8px;
            padding-top: 12px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .summary-value {
            font-weight: 500;
        }
        
        .summary-value.positive {
            color: #4CAF50;
        }
        
        .summary-value.negative {
            color: #F44336;
        }
        
        .ai-analysis {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .ai-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .ai-content {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .loader {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
        <p class="subtitle">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>
        
        <form id="financialForm">
            <div class="form-group">
                <label for="balance">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (‚ÇΩ)</label>
                <input type="number" id="balance" placeholder="50000" required>
                <div class="input-hint">–°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ —É –≤–∞—Å —Å–µ–π—á–∞—Å –µ—Å—Ç—å</div>
            </div>
            
            <div class="form-group">
                <label for="income">–ú–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥ (‚ÇΩ)</label>
                <input type="number" id="income" placeholder="80000" required>
                <div class="input-hint">–°–∫–æ–ª—å–∫–æ –≤—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ –≤ –º–µ—Å—è—Ü</div>
            </div>
            
            <div class="form-group">
                <label for="expenses">–ú–µ—Å—è—á–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (‚ÇΩ)</label>
                <input type="number" id="expenses" placeholder="60000" required>
                <div class="input-hint">–°–∫–æ–ª—å–∫–æ –≤—ã —Ç—Ä–∞—Ç–∏—Ç–µ –≤ –º–µ—Å—è—Ü</div>
            </div>
            
            <div class="form-group">
                <label for="goal">–¶–µ–ª—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π (‚ÇΩ, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="number" id="goal" placeholder="500000">
                <div class="input-hint">–°–∫–æ–ª—å–∫–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞–∫–æ–ø–∏—Ç—å</div>
            </div>
            
            <div class="form-group">
                <label for="notes">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="notes" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–ª–∞–Ω–∏—Ä—É—é –ø–æ–∫—É–ø–∫—É –∞–≤—Ç–æ —á–µ—Ä–µ–∑ –≥–æ–¥"></textarea>
            </div>
        </form>
        
        <div class="summary" id="summary" style="display: none;">
            <div class="summary-title">üìä –í–∞—à–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –º–æ–¥–µ–ª—å</div>
            <div class="summary-item">
                <span>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:</span>
                <span class="summary-value" id="summaryBalance">0 ‚ÇΩ</span>
            </div>
            <div class="summary-item">
                <span>–î–æ—Ö–æ–¥ –≤ –º–µ—Å—è—Ü:</span>
                <span class="summary-value positive" id="summaryIncome">0 ‚ÇΩ</span>
            </div>
            <div class="summary-item">
                <span>–†–∞—Å—Ö–æ–¥—ã –≤ –º–µ—Å—è—Ü:</span>
                <span class="summary-value negative" id="summaryExpenses">0 ‚ÇΩ</span>
            </div>
            <div class="summary-item total">
                <span>–ï–∂–µ–º–µ—Å—è—á–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è:</span>
                <span class="summary-value" id="summarySavings">0 ‚ÇΩ</span>
            </div>
            <div class="summary-item" id="goalSection" style="display: none;">
                <span>–î–æ —Ü–µ–ª–∏:</span>
                <span class="summary-value" id="summaryGoalTime">0 –º–µ—Å</span>
            </div>
        </div>
        
        <div class="ai-analysis" id="aiAnalysis" style="display: none;">
            <div class="ai-title">ü§ñ AI –ê–Ω–∞–ª–∏–∑</div>
            <div class="loader" id="aiLoader">
                <div class="spinner"></div>
            </div>
            <div class="ai-content" id="aiContent" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        // Wait for Telegram Web App SDK to load
        function initApp() {
            if (!window.Telegram || !window.Telegram.WebApp) {
                console.error('Telegram Web App SDK not loaded');
                document.body.innerHTML = '<div style="padding: 20px; text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram.</div>';
                return;
            }
            
            const tg = window.Telegram.WebApp;
            tg.expand();
            tg.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑');
            tg.MainButton.show();
            
            const form = document.getElementById('financialForm');
            const summary = document.getElementById('summary');
            const aiAnalysis = document.getElementById('aiAnalysis');
            const aiLoader = document.getElementById('aiLoader');
            const aiContent = document.getElementById('aiContent');
            
            function updateSummary() {
                const balance = parseInt(document.getElementById('balance').value) || 0;
                const income = parseInt(document.getElementById('income').value) || 0;
                const expenses = parseInt(document.getElementById('expenses').value) || 0;
                const goal = parseInt(document.getElementById('goal').value) || 0;
                
                if (balance || income || expenses) {
                    summary.style.display = 'block';
                    
                    document.getElementById('summaryBalance').textContent = balance.toLocaleString('ru-RU') + ' ‚ÇΩ';
                    document.getElementById('summaryIncome').textContent = income.toLocaleString('ru-RU') + ' ‚ÇΩ';
                    document.getElementById('summaryExpenses').textContent = expenses.toLocaleString('ru-RU') + ' ‚ÇΩ';
                    
                    const savings = income - expenses;
                    const savingsEl = document.getElementById('summarySavings');
                    savingsEl.textContent = savings.toLocaleString('ru-RU') + ' ‚ÇΩ';
                    savingsEl.className = 'summary-value ' + (savings > 0 ? 'positive' : savings < 0 ? 'negative' : '');
                    
                    if (goal > 0 && savings > 0) {
                        const goalSection = document.getElementById('goalSection');
                        const remaining = Math.max(0, goal - balance);
                        const months = Math.ceil(remaining / savings);
                        goalSection.style.display = 'block';
                        document.getElementById('summaryGoalTime').textContent = months + ' –º–µ—Å';
                    }
                }
            }
            
            // Auto-update summary on input
            form.addEventListener('input', updateSummary);
            
            tg.MainButton.onClick(async () => {
                const balance = parseInt(document.getElementById('balance').value) || 0;
                const income = parseInt(document.getElementById('income').value) || 0;
                const expenses = parseInt(document.getElementById('expenses').value) || 0;
                const goal = parseInt(document.getElementById('goal').value) || 0;
                const notes = document.getElementById('notes').value;
                
                if (!balance && !income && !expenses) {
                    tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ');
                    return;
                }
                
                tg.MainButton.showProgress();
                
                // Show AI analysis section
                aiAnalysis.style.display = 'block';
                aiLoader.style.display = 'block';
                aiContent.style.display = 'none';
                
                try {
                    // Send data to backend
                    const response = await fetch('/api/financial-modeling/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            initData: tg.initData,
                            balance,
                            income,
                            expenses,
                            goal,
                            notes
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Show AI analysis
                        aiLoader.style.display = 'none';
                        aiContent.style.display = 'block';
                        aiContent.textContent = result.analysis;
                        
                        tg.MainButton.hideProgress();
                        tg.showAlert('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.');
                    } else {
                        throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    }
                } catch (error) {
                    tg.MainButton.hideProgress();
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + error.message);
                    aiAnalysis.style.display = 'none';
                }
            });
            
            // Initialize summary on load
            updateSummary();
        }
        
        // Initialize app when DOM and Telegram SDK are ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
